<?php
/**
 * @file
 * Code for the VIU Simple FAQ feature.
 */

include_once 'viu_simple_faq.features.inc';

/**
 * Implements hook_views_api_alter()
 *
 * Views api is specified by features but we want to add the template directory.
 */
function viu_simple_faq_views_api_alter(&$apis) {
  if (!empty($apis['viu_simple_faq']) && $apis['viu_simple_faq']['api'] == '3.0') {
    $apis['viu_simple_faq']['template path'] = drupal_get_path('module', 'viu_simple_faq') . '/templates/views';
  }
}

/**
 * Implements hook_preprocess_HOOK
 *
 * We want to override the panels_bootstrap_pane hook and inject some HTML (for the fa-icon)
 */
function viu_simple_faq_preprocess_panels_bootstrap_pane(&$vars) {
  //Target the Categories pane:
  if ('FAQ Categories' == $vars['title']) {
    $vars['title'] = '<span aria-hidden="true" class="icon-question"></span>&nbsp;' . $vars['title'];
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function viu_simple_faq_form_oa_section_node_form_alter(&$form, &$form_state, $form_id) {
  // TODO add conditional to check whether we are looking at a section page form (check taxonomy id)
//  sdpm($form_state['node']);
//  $section_term_id = $form_state['node']->field_oa_section[LANGUAGE_NONE]['0']['tid'];
//  $taxonomy = taxonomy_term_load($section_term_id);
//  sdpm($taxonomy);
  //TODO See if we can do these through the UI instead of here (configuration instead of customization)
  if ($form['#node_edit_form']) {
    if (NULL == $form['body'][LANGUAGE_NONE][0]['#default_value']) {
      $form['body'][LANGUAGE_NONE][0]['#default_value'] = t('Please feel free to contact us about other specific questions that you might have.');
    }
    if (NULL == $form['body'][LANGUAGE_NONE][0]['#description']) {
      $form['body'][LANGUAGE_NONE][0]['#description'] = t('You should update the section below with a link to your staff directory, contact page or contact form.');
    }
    //sdpm($form);
    //sdpm($form_state);
    //sdpm($form_id);
  }
}

/**
 * Implements hook_permission().
 */
function viu_simple_faq_permission() {
  return array(
    'access viu_simple_faq administration' => array(
      'title' => t('Manage Simple FAQ'),
    ),
  );
}

/**
 * Implements hook_menu().
 *
 * Provide administration links on the section page
 */
function viu_simple_faq_menu() {
  /*$items['node/%node/faq_section'] = array(
    'title' => 'FAQ Section Display',
    'page callback' => 'node_page_default',
    'access callback' => '_viu_simple_faq_access_callback',
    'access arguments' => array(1),
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );*/// This works but only on the default node view page, not the panelizer/section page (I wonder why?)

  $items['node/%node/manage_faq'] = array(
    'title' => t('Manage FAQ Items'),
    'page callback' => '_viu_simple_faq_manage_content',
    'page arguments' => array(1),
    'access callback' => '_viu_simple_faq_access_callback',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => -10,
  );

  $items['node/%node/faq_categories/%section'] = array(
    'title' => t('Manage FAQ Categories'),
    'page callback' => 'drupal_goto',
    'access callback' => '_viu_simple_faq_access_callback',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_entity_info_alter().
 */
function viu_simple_faq_entity_info_alter(&$entity_info) {
//  $entity_info['taxonomy_vocabulary']['fieldable'] = TRUE;
//  sdpm($entity_info);
}

/**
 * Access callback for managing FAQ nodes
 */
function _viu_simple_faq_access_callback($node) {
  //TODO Limit to only FAQ sections
  return 'oa_section' == $node->type && user_access('access viu_simple_faq administration');
}

/**
 * Page routing mechanism for Manage FAQ menu tab
 */
function _viu_simple_faq_manage_content($node) {
  drupal_goto(url('node/' . $node->nid . '/content'));
}

//TODO Dead End code below - needs to be checked whether deprecated or not

/**
 * Implements hook_form_alter().
 *
 * @todo Deprecated - Can use this hook for viewing the data structures on node edit or creation (for FAQ section pages)
 */
function viu_simple_faq_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == "oa_section_node_form" && $form['#node_edit_form']) {
    //sdpm($form);
    //sdpm($form_state);
    //dpm($form_id);
    //sdpm($form_state['node']);
    //$section_term_id = $form_state['node']->field_oa_section[LANGUAGE_NONE]['0']['tid'];
    //$taxonomy = taxonomy_term_load($section_term_id);
    //dpm($taxonomy);
    //WORKING HERE
  }
}
/**
 * Implements hook_node_view().
 *
 * Redirect individual node view to the testimonial list page
 *
 */
function viu_simple_faq_node_view($node, $view_mode, $langcode) {
  sdpm($node);
}

/**
 * Implements hook_entity_insert().
 */
function viu_simple_faq_entity_insert($entity, $type) {
  //TODO Double check this conditional doesn't fire when it's not supposed to
  if ($type == 'node' && $entity->type == 'oa_section') {
    if ($entity->panelizer['page_manager']->name == 'node:oa_section:simple_faq_section') {
      //Gather information we need for the name of the new taxonomy vocabulary:
      $og_context = og_context();
      sdpm($og_context);
      $group = node_load($og_context['gid']);
      sdpm($group);

      $new_vocab_machine_name = str_replace('-', '_', strtolower($group->title)) . "_default_faq_categories";
      //TODO Taxonomy Todos: check duplicate names?  check that machine name duplication is allowed (auto-handled), implement your own if it's not
      // Check that a context is available
      // Check no duplicates
      // Consider other error checks
      $new_vocab = (object) array(
        'name' => $group->title . ' - FAQ Categories',
        'description' => "Default " . $group->title . " FAQ categories vocabulary",
        'machine_name' => $new_vocab_machine_name,
      );
      
      taxonomy_vocabulary_save();
      
      //Grab the default og vocab data structure:
      //require_once drupal_get_path('module', 'ultimate_cron') . '/includes/nicejson.php';

      //Generate OG Vocab Entity
      $og_vocab = og_vocab_load_og_vocab(0, "node", "viu_simple_faq_question", NULL, TRUE);

      sdpm($og_vocab);

      //Populate the values:

      //Grab the required parameters for OG Vocab settings
      $vid = NULL;
      $group_type = NULL;
      $gid = NULL;
      $settings = NULL;

      //Populate the og vocab settings and relationship tables
      //og_vocab_relation_save($);



      //All code below duplicates the default behaviour of OG Vocab, except just for our section only.
      //taxonomy_vocabulary_save($new_vocab);
      //Add as an og_vocab



      //attach to simple Q&A Content
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * For development only, to retrieve Section Default Term properties (for export)
 */
function viu_simple_faq_entity_update($entity, $type) {
  //sdpm($entity);
}
